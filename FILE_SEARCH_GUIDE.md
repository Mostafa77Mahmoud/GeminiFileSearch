# ุฏููู ุงุณุชุฎุฏุงู File Search ูู ุงููุดุฑูุน

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงููุดุฑูุน ูุณุชุฎุฏู **Google Gemini File Search API** ูุชุญููู ุงูุนููุฏ ุจูุงุกู ุนูู ูุนุงููุฑ AAOIFI ุงูุดุฑุนูุฉ. ุงููุธุงู ูุนุชูุฏ ุจุงููุงูู ุนูู **Gemini** ููุจุญุซ ูุงูุงุณุชุฑุฌุงุน ุจุฏูู ุฃู ุชุนุฏููุงุช ูุฏููุฉ ุนูู ุงูู chunks ุฃู ุงูููุฑุณุฉ.

---

## ๐๏ธ ุงูุจููุฉ ุงููุนูุงุฑูุฉ (Architecture Pipeline)

```
1. [User Input] ูุต ุงูุนูุฏ
        โ
2. [Prompt Template] ุชุทุจูู ูุงูุจ ุงูุจุญุซ ูู Config
        โ
3. [Gemini File Search] ุงูุจุญุซ ูู File Search Store
        โ
4. [Grounding Chunks] ุงุณุชุฎุฑุงุฌ ุงูู chunks ูู ุงููุณุชูุฏุงุช
        โ
5. [API Response] ุฅุฑุฌุงุน ุงููุชุงุฆุฌ ุฅูู ุงููุณุชุฎุฏู
```

---

## โ๏ธ Configuration - ููู `config.py`

ุฌููุน ุงูุฅุนุฏุงุฏุงุช ููุฌูุฏุฉ ูู `config.py` - **ูุง ููุฌุฏ ุฃู prompts hardcoded ูู ุงูููุฏ**.

### 1๏ธโฃ `FILE_SEARCH_PROMPT` (ุฃูู ุฅุนุฏุงุฏ!)

**ุงููุธููุฉ:** ูุงูุจ ุงูู prompt ุงูููุณุชุฎุฏู ููุจุญุซ ูู ุงููุณุชูุฏุงุช ุงููุฑุฌุนูุฉ

**ุงููููุน ูู Pipeline:** ุงููุฑุญูุฉ 2 - ูุชู ุชุทุจููู ุนูู ูุต ุงูุนูุฏ ูุจู ุฅุฑุณุงูู ูู Gemini

**ุงูุงุณุชุฎุฏุงู ูู ุงูููุฏ:**
```python
# ูู services/file_search.py - ุงูุณุทุฑ 161
full_prompt = self.search_prompt_template.format(contract_text=contract_text)
```

**ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:**
```
ูุฌุจ ุนููู ุงูุจุญุซ ูู ุงููุณุชูุฏุงุช ุงููุฑุฌุนูุฉ (ูุนุงููุฑ ููุฆุฉ AAOIFI ุงูุดุฑุนูุฉ) ุนู ูุนูููุงุช ูุชุนููุฉ ุจุงููุต ุงูุชุงูู.

ุงุณุชุฎุฏู File Search ููุจุญุซ ูู ุงููุณุชูุฏุงุช ุงููุฑููุฉ ูุงุณุชุฎุฑุฌ ุฌููุน ุงูููุงุทุน (chunks) ุฐุงุช ุงูุตูุฉ.

ุงููุต ุงููุทููุจ ุชุญูููู:
{contract_text}

ูู ุจุงูุจุญุซ ูู ุงููุณุชูุฏุงุช ุงููุฑุฌุนูุฉ ุนู:
1. ุงูุฃุญูุงู ูุงููุนุงููุฑ ุงูุดุฑุนูุฉ ุงููุชุนููุฉ ุจูุฐุง ุงูููุน ูู ุงูุนููุฏ
2. ุงูุดุฑูุท ูุงูุถูุงุจุท ุงูุดุฑุนูุฉ
3. ุงูุญุงูุงุช ุงููุดุงุจูุฉ ุฃู ุงูุฃูุซูุฉ
4. ุงูุฃุญูุงู ุงูุฎุงุตุฉ ุจุงููุฎุงููุงุช ุฃู ุงูุฌุฒุงุกุงุช
5. ุฃู ูุนูููุงุช ุฃุฎุฑู ุฐุงุช ุตูุฉ ูู ูุนุงููุฑ AAOIFI

ูุฌุจ ุงุณุชุฎุฏุงู ุงููุณุชูุฏุงุช ุงููุฑููุฉ ูู ุงูุฅุฌุงุจุฉ.
```

**ููุงุฐุง ูุฐุง ุงูู Prompt ูููุ**
- โ ููุฌุจุฑ Gemini ุนูู ุงุณุชุฎุฏุงู File Search (ุจุฏูุงู ูู ุงููุนุฑูุฉ ุงูุฏุงุฎููุฉ)
- โ ูุญุฏุฏ ุจูุถูุญ ููุน ุงููุนูููุงุช ุงููุทููุจุฉ
- โ ูุนูู ุญุชู ูุน ุงููุตูุต ุงููุตูุฑุฉ (<100 ุญุฑู)

**ููู ุชุนุฏูู ุงูู Promptุ**
```bash
# ูู ููู .env:
FILE_SEARCH_PROMPT="your custom prompt here with {contract_text} placeholder"
```

---

### 2๏ธโฃ `TOP_K_CHUNKS`

**ุงููุธููุฉ:** ุนุฏุฏ ุงูู chunks ุงูููุณุชุฑุฌุนุฉ ูู File Search

**ุงููููุน ูู Pipeline:** ุงููุฑุญูุฉ 3 - ูุชู ุชูุฑูุฑู ูู Gemini API ูู `FileSearch(top_k=...)`

**ุงูุงุณุชุฎุฏุงู ูู ุงูููุฏ:**
```python
# ูู services/file_search.py - ุงูุณุทุฑ 176
types.FileSearch(
    file_search_store_names=[self.store_id],
    top_k=top_k  # ูุฃุชู ูู Config.TOP_K_CHUNKS
)
```

**ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ:** `20`

**ููุงุญุธุงุช:**
- ูููุง ุฒุงุฏ ุงูุฑูู โ ูุชุงุฆุฌ ุฃูุซุฑ ููู ุงุณุชุฌุงุจุฉ ุฃุจุทุฃ
- ุงููุทุงู ุงููููุตู ุจู: 5-50 chunk
- ูููู ุชุนุฏููู ููู ุทูุจ ุนุจุฑ API

---

### 3๏ธโฃ `CHUNK_SCHEMA`

**ุงููุธููุฉ:** ุชูุซูู ูููู ุงูุจูุงูุงุช ุงูููุฑุฌุนุฉ ูู File Search

**ุงููููุน ูู Pipeline:** ุงููุฑุญูุฉ 5 - ููุณุชุฎุฏู ููุท ููุชูุซูู ูู docstrings

**ุงูุงุณุชุฎุฏุงู ูู ุงูููุฏ:**
```python
# ูู services/file_search.py - ุงูุณุทุฑ 139-147
# ููุณุชุฎุฏู ูู docstring ุงูุฏุงูุฉ ูุชูุถูุญ ูููู ุงูุจูุงูุงุช ุงูููุฑุฌุนุฉ
"""
Returns:
    List[Dict]: ูุงุฆูุฉ ุจุงูู chunks ุงููุณุชุฑุฌุนุฉ ูู File Search
    ูู chunk ูุญุชูู ุนูู ุงูุญููู ุงูุชุงููุฉ:
    - uid: ูุนุฑูู ูุฑูุฏ ููู chunk
    - chunk_text: ูุต ุงูู chunk ุงูุฃุตูู ูู ุงููุณุชูุฏ
    - score: ุฏุฑุฌุฉ ุงูุตูุฉ (0.0 - 1.0)
    - uri: ูุตุฏุฑ ุงูููู (URI)
    - title: ุนููุงู ุงูููู ุฃู ุงููุณู
"""
```

**ููุงุญุธุฉ:** ูุฐุง ุงูุฅุนุฏุงุฏ **ููุชูุซูู ููุท** - ูุง ูุคุซุฑ ุนูู ุนูููุฉ ุงูุจุญุซ

---

### 4๏ธโฃ ุฅุนุฏุงุฏุงุช ุฃุฎุฑู

| ุงูุฅุนุฏุงุฏ | ุงููุธููุฉ | ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ |
|---------|----------|-------------------|
| `MODEL_NAME` | ูููุฐุฌ Gemini ุงูููุณุชุฎุฏู | `gemini-2.5-flash` |
| `FILE_SEARCH_STORE_ID` | ูุนุฑูู ูุฎุฒู ุงููุณุชูุฏุงุช | ูุชู ุฅูุดุงุคู ุชููุงุฆูุงู |
| `CONTEXT_DIR` | ูุฌูุฏ ุงููุณุชูุฏุงุช ุงููุฑุฌุนูุฉ | `context` |
| `FLASK_HOST` | ุนููุงู Flask API | `0.0.0.0` |
| `FLASK_PORT` | ูููุฐ Flask API | `5001` |

---

## ๐ค ูู ููุงู Configuration ูุฏููุ

### โ ูุง ููุฌุฏ ุชุนุฏูู ูุฏูู ุนูู:
- **Chunking:** Gemini ูููู ุจุชูุณูู ุงููุณุชูุฏุงุช ุชููุงุฆูุงู
- **Embeddings:** Gemini ูููุดุฆ embeddings ุชููุงุฆูุงู
- **Ranking:** ุงูู chunks ููุฑุชุจุฉ ุญุณุจ ุงูุตูุฉ ุชููุงุฆูุงู ูู Gemini
- **Indexing:** ุงูููุฑุณุฉ ุชุชู ุชููุงุฆูุงู ุนูุฏ ุฑูุน ุงูููู

### โ ุงูุชุนุฏููุงุช ุงููุฏููุฉ ุงููุญูุฏุฉ:
1. **Prompt Engineering:** ุชุญุณูู ุงูู prompt ูู `FILE_SEARCH_PROMPT`
2. **Top-K Selection:** ุงุฎุชูุงุฑ ุนุฏุฏ ุงูู chunks ุงููุทููุจุฉ
3. **Store Management:** ุฅูุดุงุก ูุฅุฏุงุฑุฉ File Search Store

---

## ๐ ุชุฏูู ุงูุจูุงูุงุช ุงูุชูุตููู (Detailed Pipeline)

### 1๏ธโฃ **Initialization (ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุงูุจุฏุก)**
```
app.py โ initialize_services()
    โ
FileSearchService.__init__()
    โ
initialize_store()
    โ
[ุฅูุง ุงูุงุชุตุงู ุจู Store ููุฌูุฏ ุฃู ุฅูุดุงุก ุฌุฏูุฏ]
    โ
_upload_context_files() [ุฑูุน ูููุงุช ูู context/]
    โ
[Gemini: ููุฑุณุฉ ุชููุงุฆูุฉ]
```

### 2๏ธโฃ **Search Request (ููู ุทูุจ ุจุญุซ)**
```
User โ POST /file_search {"contract_text": "..."}
    โ
app.py โ file_search_service.search_chunks()
    โ
[ุชุทุจูู FILE_SEARCH_PROMPT]
full_prompt = FILE_SEARCH_PROMPT.format(contract_text=contract_text)
    โ
[ุฅุฑุณุงู ูู Gemini API]
client.models.generate_content(
    contents=full_prompt,
    tools=[FileSearch(top_k=TOP_K_CHUNKS)]
)
    โ
[Gemini: ุจุญุซ + ุชุฑุชูุจ ุชููุงุฆู]
    โ
[ุงุณุชุฎุฑุงุฌ Grounding Chunks]
_extract_grounding_chunks(response)
    โ
[ุจูุงุก JSON Response]
{
    "chunks": [
        {"uid": "chunk_1", "chunk_text": "...", "score": 1.0, ...},
        ...
    ],
    "total_chunks": 20
}
    โ
User โ JSON Response
```

---

## ๐ง ููููุฉ ุงูุชุนุฏูู ูุงูุชุฎุตูุต

### ุชุบููุฑ ุงูู Prompt
ุฃูุดุฆ ููู `.env` ูุฃุถู:
```env
FILE_SEARCH_PROMPT=your custom Arabic prompt with {contract_text}
```

### ุชุบููุฑ ุนุฏุฏ ุงูู Chunks
```env
TOP_K_CHUNKS=30
```

### ุงุณุชุฎุฏุงู ูููุฐุฌ Gemini ูุฎุชูู
```env
MODEL_NAME=gemini-2.0-flash-exp
```

---

## ๐ ุงููููุงุช ุงูุฑุฆูุณูุฉ

| ุงูููู | ุงููุธููุฉ |
|-------|---------|
| `config.py` | ุฌููุน ุงูุฅุนุฏุงุฏุงุช ูุงูู prompts |
| `services/file_search.py` | ููุทู File Search ุจุงููุงูู |
| `app.py` | Flask API endpoints |
| `frontend.py` | ูุงุฌูุฉ Streamlit |
| `context/` | ูุฌูุฏ ุงููุณุชูุฏุงุช ุงููุฑุฌุนูุฉ (AAOIFI) |

---

## โ ููุฎุต ุงูุฅุนุฏุงุฏุงุช ุงูููุณุชุฎุฏูุฉ ูุนููุงู

| ุงูุฅุนุฏุงุฏ | ููุณุชุฎุฏู ูู ุงูููุฏุ | ุงููุธููุฉ |
|---------|-------------------|---------|
| `FILE_SEARCH_PROMPT` | โ ูุนู | ูุงูุจ ุงูุจุญุซ ุงูุฃุณุงุณู |
| `TOP_K_CHUNKS` | โ ูุนู | ุนุฏุฏ ุงููุชุงุฆุฌ ุงูููุณุชุฑุฌุนุฉ |
| `CHUNK_SCHEMA` | โ ูุนู (ุชูุซูู) | ูููู ุงูุจูุงูุงุช ุงูููุฑุฌุนุฉ |
| `MODEL_NAME` | โ ูุนู | ูููุฐุฌ Gemini |
| `FILE_SEARCH_STORE_ID` | โ ูุนู | ูุนุฑูู ุงููุฎุฒู |
| `CONTEXT_DIR` | โ ูุนู | ูุฌูุฏ ุงููุณุชูุฏุงุช |

**ุฌููุน ุงูุฅุนุฏุงุฏุงุช ููุณุชุฎุฏูุฉ - ูุง ููุฌุฏ ุฅุนุฏุงุฏุงุช ุบูุฑ ููุณุชุฎุฏูุฉ!**

---

## ๐ฏ ุฃูุถู ุงูููุงุฑุณุงุช

1. **ุงุณุชุฎุฏู prompts ูุงุถุญุฉ:** ุงุฐูุฑ "File Search" ู "AAOIFI" ุตุฑุงุญุฉู
2. **ุงุจุฏุฃ ุจู Top-K ุตุบูุฑ:** 10-20 ููุงุฎุชุจุงุฑุ ุซู ุฒูุฏ ุญุณุจ ุงูุญุงุฌุฉ
3. **ุงุญูุธ Store ID:** ุฃุถู `FILE_SEARCH_STORE_ID` ูู `.env` ูุชุฌูุจ ุฅูุดุงุก stores ุฌุฏูุฏุฉ
4. **ุฑุงุฌุน ุงูููุบุงุช:** ุงูู logs ุชูุถุญ ุจุงูุถุจุท ูุง ูุญุฏุซ ูู ูู ูุฑุญูุฉ

---

**ุขุฎุฑ ุชุญุฏูุซ:** 24 ููููุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ููุซูุฉ ูููุณุชุฎุฏูุฉ ุจุดูู ุตุญูุญ
