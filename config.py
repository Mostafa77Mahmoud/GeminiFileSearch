import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """إعدادات المشروع"""

    # Gemini API Configuration
    GEMINI_API_KEY = os.getenv("GEMINI_API_KEY", "")
    MODEL_NAME = os.getenv("MODEL_NAME", "gemini-2.5-flash")

    # File Search Store Configuration
    FILE_SEARCH_STORE_ID = os.getenv("FILE_SEARCH_STORE_ID", "")
    CONTEXT_DIR = "context"

    # Search Configuration
    TOP_K_CHUNKS = int(os.getenv("TOP_K_CHUNKS", "20"))

    # المرحلة الأولى: Prompt لاستخراج البنود المهمة من العقد
    # ملاحظة: Keywords باللغة العربية لتطابق embeddings AAOIFI (المستند عربي)
    EXTRACT_KEY_TERMS_PROMPT = os.getenv(
        "EXTRACT_KEY_TERMS_PROMPT",
        """أنت خبير شرعي متخصص في تحليل العقود المالية الإسلامية وفق معايير هيئة المحاسبة والمراجعة للمؤسسات المالية الإسلامية (AAOIFI).

        مهمتك: قراءة نص العقد كاملاً (أي نوع من العقود: بيع، مرابحة، إجارة، استصناع، مشاركة، مضاربة، سلم، تورق، صكوك، تمويل، إلخ) واستخراج **البنود الرئيسية ذات الصلة الشرعية العالية** فقط، أي البنود التي قد تتعلق بأحد المحاذير الشرعية أو الضوابط المهمة مثل:

        - الغرر، الجهالة، الغموض في المبيع أو الثمن أو الأجل
        - الربا (فائدة التأخير، التعويض غير المبرر، الزيادة على الدين)
        - الشرط الجائر أو الباطل أو المخالف لمقتضى العقد
        - الجزاءات والتعويضات والشرط الجزائي
        - انتقال الملكية والضمان والمخاطر
        - الوعد الملزم، الوعد بالتمليك، الهبة المعلقة
        - التحكيم، الإكراه، الظلم، الضرر، قوة القاهرة
        - الضمانات (كفالة، رهن، حوالة)
        - الدفعات، الأقساط، التأمين التكافلي، إعادة الجدولة
        - أي بند يحتمل مخالفة لأحد معايير AAOIFI

        الخطوات:
        1. ركز فقط على 5-15 بنداً من أكثر البنود أهمية شرعية (تجنب الروتيني مثل تعريف الأطراف، التاريخ، العناوين العامة إلا إذا كان فيها مخالفة واضحة).
        2. لكل بند مهم، استخرج:
           - term_id: معرف فريد وواضح (مثل: clause_penalty, clause_delay_interest, clause_rejection_right, clause_ownership_transfer, clause_arbitration).
           - term_text: النص الكامل للبند بالضبط كما هو في العقد (مع الحفاظ على التنسيق إن أمكن).
           - potential_issues: قائمة بالمصطلحات الشرعية العربية الدقيقة من معايير AAOIFI (اختر من القائمة التالية أو أضف ما يناسب بدقة):
             ["الغرر", "الجهالة", "الربا", "فائدة التأخير", "التعويض غير المشروع", "الشرط الباطل", "الشرط الجائر", "الظلم", "الإكراه", "الضرر", "الوعد الملزم", "انتقال الملكية", "تحمل المخاطر", "الاستصناع", "المرابحة", "الإجارة المنتهية بالتمليك", "السلم", "التورق", "التحكيم", "الشروط", "قوة القاهرة", "الكفالة", "الرهن"]
           - relevance_reason: جملة واحدة مختصرة توضح لماذا هذا البند مهم شرعياً (مثل: "يحتوي على تعويض مالي عند التأخير دون إثبات ضرر فعلي"، "عدم وضوح انتقال الملكية والمخاطر").

        أخرج النتيجة كـ JSON صالح فقط، بدون أي نص خارجي:

        [
          {
            "term_id": "clause_delay_compensation",
            "term_text": "في حالة التأخير في السداد يلتزم العميل بدفع تعويض يومي قدره 0.1%...",
            "potential_issues": ["الربا", "فائدة التأخير", "التعويض غير المشروع"],
            "relevance_reason": "فرض زيادة على المدين عند التأخير دون إثبات ضرر فعلي"
          }
        ]

        نص العقد:
        {contract_text}
        """)

    # المرحلة الثانية: Prompt محسّن لـ File Search باستخدام البنود المستخرجة
    # ملاحظة: Keywords بالعربية لتطابق أفضل مع Embeddings AAOIFI
    FILE_SEARCH_PROMPT = os.getenv(
        "FILE_SEARCH_PROMPT",
        """أنت الآن في مرحلة البحث الدلالي العميق داخل كتاب معايير AAOIFI الشرعية الكامل (باللغة العربية) باستخدام ميزة File Search.

    مهمتك: استرجاع أدق وأكثر المقاطع (chunks) صلة بكل بند مستخرج من العقد، مع التركيز على:
    - الأحكام الشرعية الدقيقة المتعلقة بنوع العقد (مرابحة، استصناع، إجارة منتهية بالتمليك، سلم، بيع بالتقسيط، مشاركة متناقصة، إلخ)
    - الضوابط والشروط الصحيحة والباطلة
    - أمثلة المخالفات الشائعة من قرارات هيئة المحاسبة والمراجعة
    - الأحكام الخاصة بالشرط الجزائي، التعويض عن الضرر الفعلي فقط، فائدة التأخير، الغرر في الرفض، انتقال الملكية والمخاطر، الوعد الملزم، الهبة المعلقة، التحكيم، الشروط الجائرة، قوة القاهرة، إلخ.

    البنود المستخرجة من العقد (استخدم كل بند كاستعلام منفصل لضمان أعلى دقة):
    {extracted_clauses}

    قم بالبحث باستخدام أقوى أسلوب دلالي ممكن عن:
    1. رقم المعيار الشرعي الدقيق من AAOIFI المتعلق بكل بند (مثل: المعيار 8 - المرابحة، المعيار 9 - الإجارة، المعيار 11 - الاستصناع، المعيار 12 - السلم، المعيار 17 - الجزاءات، المعيار 1 - الضمانات، إلخ).
    2. النصوص الرسمية من الكتاب تحديدًا التي تحتوي على كلمات مثل: "لا يجوز"، "يجوز بشرط"، "يبطل العقد"، "مخالف لمقتضى العقد"، "ضرر فعلي"، "تعويض مثبت"، "غرر"، "ربا"، "شرط جائر".
    3. الأمثلة العملية أو الحالات المشابهة التي ذكرتها AAOIFI.
    4. قرارات مجمع الفقه الإسلامي الدولي المُستند إليها في المعايير.

    يجب أن تكون النتيجة مبنية حصريًا على محتوى المستندات الموجودة في الـ File Search Store، مع استرجاع أكبر عدد ممكن من الـ chunks ذات الصلة العالية (استخدم max_retrieved_contexts=20 إن أمكن).

    ركز على الدقة الشرعية العالية، والاقتباسات الحرفية، وتجنب أي تفسير خارجي إلا إذا كان مدعومًا بنص من الكتاب."""
    )

    # Chunk Schema Configuration (هيكل البيانات المُرجعة من File Search)
    CHUNK_SCHEMA = {
        "description": "قائمة بالـ chunks المسترجعة من File Search",
        "fields": {
            "uid": "معرّف فريد للـ chunk",
            "chunk_text": "نص الـ chunk الأصلي من المستند",
            "score": "درجة الصلة (0.0 - 1.0)",
            "uri": "مصدر الملف (URI)",
            "title": "عنوان الملف أو القسم"
        }
    }

    # Flask Configuration
    FLASK_HOST = os.getenv("FLASK_HOST", "0.0.0.0")
    FLASK_PORT = int(os.getenv("FLASK_PORT", "5001"))
    FLASK_DEBUG = os.getenv("FLASK_DEBUG", "False").lower() == "true"

    @classmethod
    def validate(cls):
        """التحقق من صحة الإعدادات الأساسية"""
        errors = []

        if not cls.GEMINI_API_KEY:
            errors.append("GEMINI_API_KEY is required")

        if errors:
            raise ValueError(f"Configuration errors: {', '.join(errors)}")

        return True
